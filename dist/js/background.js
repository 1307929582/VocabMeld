chrome.runtime.onInstalled.addListener(e=>{console.log("[VocabMeld] Extension installed/updated:",e.reason),e.reason==="install"&&chrome.storage.sync.set({apiEndpoint:"https://api.deepseek.com/chat/completions",apiKey:"",modelName:"deepseek-chat",nativeLanguage:"zh-CN",targetLanguage:"en",difficultyLevel:"B1",intensity:"medium",autoProcess:!1,showPhonetic:!0,translationStyle:"translation-original",enabled:!0,blacklist:[],whitelist:[],learnedWords:[],memorizeList:[],totalWords:0,todayWords:0,lastResetDate:new Date().toISOString().split("T")[0],cacheHits:0,cacheMisses:0}),c()});function c(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"vocabmeld-add-memorize",title:"添加到需记忆列表",contexts:["selection"]}),chrome.contextMenus.create({id:"vocabmeld-process-page",title:"处理当前页面",contexts:["page"]})})}chrome.contextMenus.onClicked.addListener((e,s)=>{if(e.menuItemId==="vocabmeld-add-memorize"&&e.selectionText){const o=e.selectionText.trim();o&&o.length<50&&chrome.storage.sync.get("memorizeList",t=>{const a=t.memorizeList||[];a.some(r=>r.word===o)||(a.push({word:o,addedAt:Date.now()}),chrome.storage.sync.set({memorizeList:a},()=>{chrome.tabs.sendMessage(s.id,{action:"processSpecificWords",words:[o]}).catch(r=>{console.log("[VocabMeld] Content script not ready, word will be processed on next page load")})}))})}e.menuItemId==="vocabmeld-process-page"&&chrome.tabs.sendMessage(s.id,{action:"processPage"})});chrome.commands.onCommand.addListener((e,s)=>{e==="toggle-translation"&&chrome.tabs.sendMessage(s.id,{action:"processPage"})});chrome.runtime.onMessage.addListener((e,s,o)=>{if(e.action==="speak")return chrome.tts.speak(e.text,{lang:e.lang||"en-US",rate:.9,pitch:1}),o({success:!0}),!0;if(e.action==="testApi")return n(e.endpoint,e.apiKey,e.model).then(t=>o(t)).catch(t=>o({success:!1,message:t.message})),!0;if(e.action==="getStats")return chrome.storage.sync.get(["totalWords","todayWords","lastResetDate","cacheHits","cacheMisses","learnedWords","memorizeList"],t=>{const a=new Date().toISOString().split("T")[0];t.lastResetDate!==a&&(t.todayWords=0,t.lastResetDate=a,chrome.storage.sync.set({todayWords:0,lastResetDate:a})),o({totalWords:t.totalWords||0,todayWords:t.todayWords||0,learnedCount:(t.learnedWords||[]).length,memorizeCount:(t.memorizeList||[]).length,cacheHits:t.cacheHits||0,cacheMisses:t.cacheMisses||0})}),!0;if(e.action==="getCacheStats")return chrome.storage.local.get("vocabmeld_word_cache",t=>{const a=t.vocabmeld_word_cache||[];o({size:a.length,maxSize:2e3})}),!0;if(e.action==="clearCache")return chrome.storage.local.remove("vocabmeld_word_cache",()=>{chrome.storage.sync.set({cacheHits:0,cacheMisses:0},()=>{o({success:!0})})}),!0;if(e.action==="clearLearnedWords")return chrome.storage.sync.set({learnedWords:[]},()=>{o({success:!0})}),!0;if(e.action==="clearMemorizeList")return chrome.storage.sync.set({memorizeList:[]},()=>{o({success:!0})}),!0});async function n(e,s,o){try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({model:o,messages:[{role:"user",content:"Say OK"}],max_tokens:10})});if(!t.ok){const r=await t.json().catch(()=>({}));throw new Error(r.error?.message||`HTTP ${t.status}`)}const a=await t.json();if(a.choices&&a.choices[0])return{success:!0,message:"连接成功！"};throw new Error("Invalid response")}catch(t){return{success:!1,message:t.message}}}chrome.action.onClicked.addListener(e=>{});chrome.tabs.onUpdated.addListener((e,s,o)=>{s.status==="complete"&&o.url?.startsWith("http")});console.log("[VocabMeld] Background script loaded");
