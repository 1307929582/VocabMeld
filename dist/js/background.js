import{s as n}from"./chunks/storage-DOvsNEMd.js";class d extends Error{constructor(t,a,r=null){super(a),this.type=t,this.httpStatus=r,this.retriable=["RATE_LIMIT","TIMEOUT","NETWORK","SERVER"].includes(t)}}class P{constructor(){this.inflightRequests=new Map,this.rateLimiters=new Map}async route(){const[t,a]=await Promise.all([n.getApiRouting(),n.getApiProfiles()]),r=a.filter(s=>s.enabled);if(t.mode==="manual"){const s=r.find(u=>u.id===t.selectedProfileId);return{mode:"manual",candidates:s?[s]:[]}}const e=[...r].sort((s,u)=>s.priority-u.priority),i=Date.now(),c=[];for(const s of e){const u=await n.getProfileHealth(s.id);if(!u){c.push(s);continue}u.status!=="blocked"&&(u.cooldownUntil&&u.cooldownUntil>i||c.push(s))}return{mode:"fallback",candidates:c}}async translate(t){const{candidates:a}=await this.route();if(a.length===0)throw new d("AUTH","No available API profiles configured");let r=null;for(let e=0;e<a.length;e++){const i=a[e];try{const c=Date.now(),s=await this.translateWithProfile(i,t),u=Date.now()-c;return await this.recordSuccess(i.id),{...s,profileId:i.id,profileName:i.name,latencyMs:u,usedFallback:e>0}}catch(c){if(console.error(`[LlmRouter] Profile "${i.name}" failed:`,c),r=c,await this.recordFailure(i.id,c),c.type==="AUTH")continue;if(!c.retriable||e===a.length-1)break;console.log("[LlmRouter] Falling back to next profile...")}}throw r||new d("UNKNOWN","All API profiles failed")}async translateWithProfile(t,a){const r=await n.getApiKey(t.apiKeyRef);if(!r)throw new d("AUTH",`API Key not found for profile "${t.name}"`);const{text:e,nativeLanguage:i,targetLanguage:c,difficultyLevel:s,intensity:u}=a,m=this.detectLanguage(e),y=m===i?c:i,x=this.buildPrompt(e,m,y,s,u),A=t.timeoutMs||25e3,g=new AbortController,h=setTimeout(()=>g.abort(),A);try{const l=await fetch(t.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`,...t.extraHeaders},body:JSON.stringify({model:t.model,messages:[{role:"user",content:x}],temperature:.3,max_tokens:2e3}),signal:g.signal});if(clearTimeout(h),!l.ok)throw l.status===401||l.status===403?new d("AUTH",`Authentication failed: ${l.status}`,l.status):l.status===429?new d("RATE_LIMIT","Rate limit exceeded",l.status):l.status>=500?new d("SERVER",`Server error: ${l.status}`,l.status):new d("NETWORK",`HTTP ${l.status}`,l.status);const p=(await l.json()).choices?.[0]?.message?.content;if(!p)throw new d("BAD_RESPONSE","Invalid response format");return{replacements:this.parseTranslations(p,s),provider:t.provider}}catch(l){throw clearTimeout(h),l.name==="AbortError"?new d("TIMEOUT","Request timeout"):l instanceof d?l:new d("NETWORK",l.message)}}detectLanguage(t){const a=(t.match(/[\u4e00-\u9fff]/g)||[]).length,r=(t.match(/[a-zA-Z]/g)||[]).length,e=a+r||1;return a/e>.3?"zh-CN":"en"}buildPrompt(t,a,r,e,i){const s={low:4,medium:8,high:14}[i]||8;return`你是语言学习助手。分析文本并选择${s}个适合学习的词汇翻译。

规则：
1. 选择约${s}个词汇
2. 避免替换：专有名词、数字、代码、URL、小于5字符的英文
3. 难度等级：${e}及以上（CEFR: A1<A2<B1<B2<C1<C2）
4. 返回JSON数组格式

文本：
${t.slice(0,2e3)}

返回格式：
[{"word":"原词","translation":"译文","phonetic":"音标","difficulty":"B2"}]`}parseTranslations(t,a){try{const r=t.match(/\[[\s\S]*\]/);if(!r)return[];const e=JSON.parse(r[0]);if(!Array.isArray(e))return[];const i=["A1","A2","B1","B2","C1","C2"],c=i.indexOf(a);return e.filter(s=>s.word&&s.translation).filter(s=>s.difficulty?i.indexOf(s.difficulty)>=c:!0).map(s=>({original:s.word,translation:s.translation,phonetic:s.phonetic||"",difficulty:s.difficulty||a}))}catch(r){return console.error("[LlmRouter] Parse error:",r),[]}}async recordSuccess(t){await n.updateProfileHealth(t,{status:"ok",consecutiveFailures:0,lastSuccessAt:Date.now(),cooldownUntil:null})}async recordFailure(t,a){const e=(await n.getProfileHealth(t)||{consecutiveFailures:0}).consecutiveFailures+1,i=Math.min(Math.pow(2,e)*5e3,3e5);await n.updateProfileHealth(t,{status:a.type==="AUTH"?"blocked":"degraded",consecutiveFailures:e,lastFailureAt:Date.now(),cooldownUntil:Date.now()+i,lastErrorCode:a.type})}async testProfile(t){const r=(await n.getApiProfiles()).find(i=>i.id===t);if(!r)return{success:!1,message:"Profile not found"};const e=await n.getApiKey(r.apiKeyRef);if(!e)return{success:!1,message:"API Key not configured"};try{const i=new AbortController,c=setTimeout(()=>i.abort(),1e4),s=await fetch(r.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:r.model,messages:[{role:"user",content:"Say OK"}],max_tokens:10}),signal:i.signal});return clearTimeout(c),s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}`}}catch(i){return i.name==="AbortError"?{success:!1,message:"Timeout"}:{success:!1,message:i.message}}}}const w=new P;chrome.runtime.onInstalled.addListener(async o=>{console.log("[VocabMeld] Extension installed/updated:",o.reason),o.reason==="install"?await b():o.reason==="update"&&await T(),L()});async function b(){const o={id:f(),name:"DeepSeek Default",provider:"deepseek",endpoint:"https://api.deepseek.com/chat/completions",model:"deepseek-chat",apiKeyRef:f(),enabled:!0,priority:10};await n.setApiProfiles([o]),await n.setApiRouting({mode:"manual",selectedProfileId:o.id,fallbackOrder:[o.id]}),await n.set({nativeLanguage:"zh-CN",targetLanguage:"en",difficultyLevel:"B1",intensity:"medium",autoProcess:!1,showPhonetic:!0,translationStyle:"translation-original",enabled:!0,blacklist:[],whitelist:[],totalWords:0,todayWords:0,lastResetDate:new Date().toISOString().split("T")[0],cacheHits:0,cacheMisses:0,learnedWords:[],memorizeList:[]}),console.log("[VocabMeld] Default configuration initialized")}async function T(){const[o,t]=await Promise.all([n.get(null),n.getLocal(["apiKey","schemaVersion"])]);if(t.schemaVersion===2){console.log("[VocabMeld] Already migrated to V2");return}const a=o.apiEndpoint||o.modelName||t.apiKey,r=o.apiProfiles&&o.apiProfiles.length>0;if(!a||r){await n.setLocal({schemaVersion:2});return}console.log("[VocabMeld] Migrating to V2 schema...");const e={id:f(),name:"Migrated Config",provider:M(o.apiEndpoint||""),endpoint:o.apiEndpoint||"https://api.deepseek.com/chat/completions",model:o.modelName||"deepseek-chat",apiKeyRef:f(),enabled:!0,priority:10};await n.setApiProfiles([e]),await n.setApiRouting({mode:"manual",selectedProfileId:e.id,fallbackOrder:[e.id]}),t.apiKey&&await n.setApiKey(e.apiKeyRef,t.apiKey,e.provider),await n.setLocal({schemaVersion:2}),console.log("[VocabMeld] Migration to V2 complete")}function M(o){return o.includes("openai.com")?"openai":o.includes("deepseek.com")?"deepseek":o.includes("moonshot.cn")?"moonshot":o.includes("groq.com")?"groq":o.includes("localhost")?"ollama":"custom"}function f(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const t=Math.random()*16|0;return(o==="x"?t:t&3|8).toString(16)})}function L(){chrome.contextMenus.create({id:"vocabmeld-process",title:"处理当前页面",contexts:["page"]})}chrome.runtime.onMessage.addListener((o,t,a)=>{const{action:r}=o;if(r==="profiles:list")return(async()=>{const e=await n.getApiProfiles();a({success:!0,data:e})})(),!0;if(r==="profiles:upsert")return(async()=>{const{profile:e,apiKey:i}=o;await n.upsertApiProfile(e),i&&e.apiKeyRef&&await n.setApiKey(e.apiKeyRef,i,e.provider),a({success:!0})})(),!0;if(r==="profiles:delete")return(async()=>(await n.deleteApiProfile(o.profileId),a({success:!0})))(),!0;if(r==="routing:get")return(async()=>{const e=await n.getApiRouting();a({success:!0,data:e})})(),!0;if(r==="routing:set")return(async()=>(await n.setApiRouting(o.routing),a({success:!0})))(),!0;if(r==="llm:translate")return(async()=>{try{const e=await w.translate(o.request);a({success:!0,data:e})}catch(e){a({success:!1,error:e.message,code:e.type})}})(),!0;if(r==="llm:testProfile")return(async()=>{try{const e=await w.testProfile(o.profileId);a(e)}catch(e){a({success:!1,message:e.message})}})(),!0;if(r==="testApi")return(async()=>{try{const{payload:e}=o;a({success:!0,message:"Please use new API management"})}catch(e){a({success:!1,error:e.message})}})(),!0;if(r==="speak"){const{text:e}=o;return e&&chrome.tts.speak(e,{lang:"en-US",rate:.9}),a({success:!0}),!1}return r==="getStats"?((async()=>{const e=await n.getConfig();a({totalWords:e.totalWords||0,todayWords:e.todayWords||0,learnedCount:(e.learnedWords||[]).length,memorizeCount:(e.memorizeList||[]).length,cacheHits:e.cacheHits||0,cacheMisses:e.cacheMisses||0})})(),!0):r==="getCacheStats"?((async()=>{const i=(await n.getLocal(["vocabmeld_word_cache"])).vocabmeld_word_cache||[];a({size:i.length,maxSize:2e3})})(),!0):(a({success:!1,error:"Unknown action"}),!1)});chrome.contextMenus.onClicked.addListener((o,t)=>{o.menuItemId==="vocabmeld-process"&&chrome.tabs.sendMessage(t.id,{action:"processPage"})});chrome.commands.onCommand.addListener(o=>{o==="toggle-translation"&&chrome.tabs.query({active:!0,currentWindow:!0},t=>{t[0]&&chrome.tabs.sendMessage(t[0].id,{action:"processPage"})})});console.log("[VocabMeld] Background service worker loaded");
