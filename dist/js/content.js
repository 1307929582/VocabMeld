(function(){"use strict";const B=["A1","A2","B1","B2","C1","C2"],O={low:{maxPerParagraph:4,label:"较少"},medium:{maxPerParagraph:8,label:"适中"},high:{maxPerParagraph:14,label:"较多"}},_={deepseek:{endpoint:"https://api.deepseek.com/chat/completions",model:"deepseek-chat"}},M={apiEndpoint:_.deepseek.endpoint,apiKey:"",modelName:_.deepseek.model,nativeLanguage:"zh-CN",targetLanguage:"en",difficultyLevel:"B1",intensity:"medium",autoProcess:!1,showPhonetic:!0,enabled:!0,blacklist:[],whitelist:[],totalWords:0,todayWords:0,lastResetDate:new Date().toISOString().split("T")[0],cacheHits:0,cacheMisses:0},v={maxSize:2e3,storageKey:"vocabmeld_word_cache"},D=["SCRIPT","STYLE","NOSCRIPT","IFRAME","OBJECT","EMBED","CANVAS","SVG","VIDEO","AUDIO","CODE","PRE","KBD","SAMP","VAR","TEXTAREA","INPUT","SELECT","BUTTON"],K=["vocabmeld-translated","vocabmeld-tooltip","highlight-mengshen","code","syntax","hljs"];function P(u,e){const t=B.indexOf(u),s=B.indexOf(e);return t>=s}class H{constructor(){this.cache=null,this.listeners=new Map}async get(e=null){return new Promise(t=>{chrome.storage.sync.get(e,s=>{if(e===null)t({...M,...s});else if(typeof e=="string")t({[e]:s[e]??M[e]});else{const o={};e.forEach(r=>{o[r]=s[r]??M[r]}),t(o)}})})}async set(e){return new Promise((t,s)=>{chrome.storage.sync.set(e,()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t()})})}async getLocal(e=null){return new Promise(t=>{chrome.storage.local.get(e,s=>{t(s)})})}async setLocal(e){return new Promise((t,s)=>{chrome.storage.local.set(e,()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t()})})}async removeLocal(e){return new Promise(t=>{chrome.storage.local.remove(e,t)})}async getConfig(){const[e,t]=await Promise.all([this.get(null),this.getLocal(["apiKey"])]);return{...e,apiKey:t.apiKey||e.apiKey||""}}async updateStats(e){const t=await this.get(["totalWords","todayWords","lastResetDate","cacheHits","cacheMisses"]),s=new Date().toISOString().split("T")[0];t.lastResetDate!==s&&(t.todayWords=0,t.lastResetDate=s);const o={totalWords:t.totalWords+(e.newWords||0),todayWords:t.todayWords+(e.newWords||0),lastResetDate:s,cacheHits:t.cacheHits+(e.cacheHits||0),cacheMisses:t.cacheMisses+(e.cacheMisses||0)};return await this.set(o),o}async getWhitelist(){return(await this.get("learnedWords")).learnedWords||[]}async addToWhitelist(e){const t=await this.getWhitelist();t.some(o=>o.original===e.original||o.word===e.word)||(t.push({original:e.original,word:e.word,addedAt:Date.now()}),await this.set({learnedWords:t}))}async removeFromWhitelist(e){const s=(await this.getWhitelist()).filter(o=>o.original!==e&&o.word!==e);await this.set({learnedWords:s})}async getMemorizeList(){return(await this.get("memorizeList")).memorizeList||[]}async addToMemorizeList(e){const t=await this.getMemorizeList();t.some(o=>o.word===e)||(t.push({word:e,addedAt:Date.now()}),await this.set({memorizeList:t}))}async removeFromMemorizeList(e){const s=(await this.getMemorizeList()).filter(o=>o.word!==e);await this.set({memorizeList:s})}async isBlacklisted(e){const{blacklist:t}=await this.get("blacklist");return(t||[]).some(s=>e.includes(s))}async isWhitelisted(e){const{whitelist:t}=await this.get("whitelist");return(t||[]).some(s=>e.includes(s))}addChangeListener(e){const t=(s,o)=>{(o==="sync"||o==="local")&&e(s,o)};return chrome.storage.onChanged.addListener(t),()=>chrome.storage.onChanged.removeListener(t)}async getApiProfiles(){return(await this.get("apiProfiles")).apiProfiles||[]}async setApiProfiles(e){await this.set({apiProfiles:e})}async upsertApiProfile(e){const t=await this.getApiProfiles(),s=t.findIndex(o=>o.id===e.id);s>=0?t[s]={...e,updatedAt:Date.now()}:t.push({...e,createdAt:Date.now(),updatedAt:Date.now()}),await this.setApiProfiles(t)}async deleteApiProfile(e){const s=(await this.getApiProfiles()).filter(o=>o.id!==e);await this.setApiProfiles(s)}async getApiRouting(){return(await this.get("apiRouting")).apiRouting||{mode:"manual",selectedProfileId:null,fallbackOrder:[]}}async setApiRouting(e){await this.set({apiRouting:e})}async getApiKey(e){return e&&((await this.getLocal(["apiKeys"])).apiKeys||{})[e]?.key||null}async setApiKey(e,t,s){const r=(await this.getLocal(["apiKeys"])).apiKeys||{};r[e]={id:e,provider:s,key:t,createdAt:r[e]?.createdAt||Date.now(),updatedAt:Date.now()},await this.setLocal({apiKeys:r})}async getProfileHealth(e){return((await this.getLocal(["profileHealth"])).profileHealth||{})[e]||null}async updateProfileHealth(e,t){const o=(await this.getLocal(["profileHealth"])).profileHealth||{};o[e]={...o[e],...t,profileId:e},await this.setLocal({profileHealth:o})}}const f=new H;class F{constructor(){this.minSegmentLength=50,this.maxSegmentLength=2e3,this.processedFingerprints=new Set}shouldSkipNode(e){if(!e||e.nodeType!==Node.ELEMENT_NODE&&e.nodeType!==Node.TEXT_NODE)return!0;if(e.nodeType===Node.TEXT_NODE)return this.shouldSkipNode(e.parentElement);const t=e;if(D.includes(t.tagName))return!0;const s=t.className?.toString()||"";if(K.some(r=>s.includes(r)))return!0;const o=window.getComputedStyle(t);return!!(o.display==="none"||o.visibility==="hidden"||t.isContentEditable||t.hasAttribute("data-vocabmeld-processed"))}isCodeText(e){return[/^(const|let|var|function|class|import|export|return|if|else|for|while)\s/,/[{}();]\s*$/,/^\s*(\/\/|\/\*|\*|#)/,/\w+\.\w+\(/,/^\s*[\w]+:\s*[\w]+/,/^[a-zA-Z_$][\w$]*\s*[=:]\s*/,/^\$\s/,/^>\s/,/console\./,/https?:\/\//].some(s=>s.test(e.trim()))}generateFingerprint(e,t=""){const s=e.slice(0,100).trim();let o=0;const r=s+t;for(let i=0;i<r.length;i++){const n=r.charCodeAt(i);o=(o<<5)-o+n,o=o&o}return o.toString(36)}getElementPath(e){const t=[];let s=e;for(;s&&s!==document.body;){let o=s.tagName.toLowerCase();if(s.id)o+=`#${s.id}`;else if(s.className){const r=s.className.toString().split(" ").slice(0,2).join(".");r&&(o+=`.${r}`)}t.unshift(o),s=s.parentElement}return t.join(">")}isProcessed(e){return this.processedFingerprints.has(e)}markProcessed(e){this.processedFingerprints.add(e)}clearProcessed(){this.processedFingerprints.clear()}getPageSegments(e=document.body,t={}){const{viewportOnly:s=!1,margin:o=300}=t,r=[];let i=0,n=1/0;s&&(i=window.scrollY-o,n=window.scrollY+window.innerHeight+o);const a=this.findTextContainers(e);for(const l of a){if(s){const y=l.getBoundingClientRect(),w=y.top+window.scrollY;if(y.bottom+window.scrollY<i||w>n)continue}const d=this.getTextContent(l);if(!d||d.length<this.minSegmentLength||this.isCodeText(d))continue;const c=this.getElementPath(l),g=this.generateFingerprint(d,c);this.isProcessed(g)||r.push({element:l,text:d.slice(0,this.maxSegmentLength),fingerprint:g,path:c})}return r}findTextContainers(e){const t=[],s=["P","DIV","ARTICLE","SECTION","LI","TD","TH","H1","H2","H3","H4","H5","H6","SPAN","BLOCKQUOTE"],o=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:i=>this.shouldSkipNode(i)?NodeFilter.FILTER_REJECT:s.includes(i.tagName)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});let r;for(;r=o.nextNode();)Array.from(r.childNodes).some(n=>n.nodeType===Node.TEXT_NODE&&n.textContent.trim().length>10)&&t.push(r);return t}getTextContent(e){const t=[],s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:r=>{if(this.shouldSkipNode(r.parentElement))return NodeFilter.FILTER_REJECT;const i=r.textContent.trim();return i.length>0&&!this.isCodeText(i)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let o;for(;o=s.nextNode();)t.push(o.textContent);return t.join(" ").replace(/\s+/g," ").trim()}getViewportSegments(e=300){return this.getPageSegments(document.body,{viewportOnly:!0,margin:e})}}const S=new F;class j{constructor(){this.replacedElements=new WeakSet}applyReplacements(e,t,s={}){if(!e||!t||t.length===0)return 0;const o=s.translationStyle||"translation-original",r=s.markProcessed!==!1;let i=0;const n=this.getTextNodes(e),a=[...t].sort((l,d)=>(d.position||0)-(l.position||0));for(const l of a){const{original:d,translation:c,phonetic:g,difficulty:y}=l;for(const w of n)if(this.replaceInTextNode(w,d,c,g,y,o)){i++;break}}return i>0&&r&&e.setAttribute("data-vocabmeld-processed","true"),i}getTextNodes(e){const t=[],s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let o;for(;o=s.nextNode();)o.textContent.trim().length>0&&t.push(o);return t}replaceInTextNode(e,t,s,o,r){const i=e.textContent,n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`(^|[\\s，。、；：""''（）\\[\\]【】])${n}([\\s，。、；：""''（）\\[\\]【】]|$)`,"i").exec(i);if(!l){const c=i.indexOf(t);return c===-1?!1:this.performReplacement(e,c,t,s,o,r)}const d=l.index+l[1].length;return this.performReplacement(e,d,t,s,o,r)}performReplacement(e,t,s,o,r,i,n){try{const a=document.createRange();if(a.setStart(e,t),a.setEnd(e,t+s.length),a.toString().toLowerCase()!==s.toLowerCase())return!1;const d=this.createWrapperElement(s,o,r,i,n);return a.deleteContents(),a.insertNode(d),!0}catch(a){return console.error("[VocabMeld] Replacement error:",a),!1}}createWrapperElement(e,t,s,o,r="translation-original"){const i=document.createElement("span");i.className="vocabmeld-translated",i.setAttribute("data-original",e),i.setAttribute("data-translation",t),i.setAttribute("data-phonetic",s||""),i.setAttribute("data-difficulty",o||"B1");const n=document.createElement("span");n.className="vocabmeld-word";const a=document.createElement("span");a.className="vocabmeld-original";const l=r||"translation-original";return l==="translation-only"?(n.textContent=t||"",i.appendChild(n),i):l==="original-translation"?(a.textContent=e||"",n.textContent=`(${t||""})`,i.appendChild(a),i.appendChild(n),i):(n.textContent=t||"",a.textContent=`(${e||""})`,i.appendChild(n),i.appendChild(a),i)}createReplacementElement(e,t,s,o){return this.createWrapperElement(e,t,s,o,"translation-original")}restoreOriginal(e){if(!e.classList.contains("vocabmeld-translated"))return;const t=e.getAttribute("data-original"),s=document.createTextNode(t);e.parentNode.replaceChild(s,e)}restoreAll(e=document.body){e.querySelectorAll(".vocabmeld-translated").forEach(s=>this.restoreOriginal(s)),e.querySelectorAll("[data-vocabmeld-processed]").forEach(s=>{s.removeAttribute("data-vocabmeld-processed")})}async markAsLearned(e){if(!e.classList.contains("vocabmeld-translated"))return;const t=e.getAttribute("data-original"),s=e.getAttribute("data-translation");await f.addToWhitelist({original:t,word:s}),this.restoreOriginal(e),this.showToast(`"${t}" 已标记为已学会`)}showToast(e){const t=document.createElement("div");t.className="vocabmeld-toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("vocabmeld-toast-show")},10),setTimeout(()=>{t.classList.remove("vocabmeld-toast-show"),setTimeout(()=>t.remove(),300)},2e3)}}const T=new j;class J{constructor(){this.cache=new Map,this.maxSize=v.maxSize,this.initialized=!1,this.initPromise=null}async init(){if(!this.initialized)return this.initPromise?this.initPromise:(this.initPromise=(async()=>{try{const t=(await f.getLocal(v.storageKey))[v.storageKey];t&&Array.isArray(t)&&t.forEach(s=>{this.cache.set(s.key,{translation:s.translation,phonetic:s.phonetic,difficulty:s.difficulty,timestamp:s.timestamp})}),this.initialized=!0,console.log(`[VocabMeld] Cache initialized with ${this.cache.size} items`)}catch(e){console.error("[VocabMeld] Failed to initialize cache:",e),this.initialized=!0}})(),this.initPromise)}generateKey(e,t,s){return`${e.toLowerCase()}:${t}:${s}`}get(e,t,s){const o=this.generateKey(e,t,s),r=this.cache.get(o);return r?(this.cache.delete(o),this.cache.set(o,r),r):null}async set(e,t,s,o){const r=this.generateKey(e,t,s);for(this.cache.has(r)&&this.cache.delete(r);this.cache.size>=this.maxSize;){const i=this.cache.keys().next().value;this.cache.delete(i)}this.cache.set(r,{translation:o.translation,phonetic:o.phonetic||"",difficulty:o.difficulty||"B1",timestamp:Date.now()}),this.persist()}async setMany(e){for(const t of e){const s=this.generateKey(t.word,t.sourceLang,t.targetLang);for(this.cache.has(s)&&this.cache.delete(s);this.cache.size>=this.maxSize;){const o=this.cache.keys().next().value;this.cache.delete(o)}this.cache.set(s,{translation:t.translation,phonetic:t.phonetic||"",difficulty:t.difficulty||"B1",timestamp:Date.now()})}await this.persist()}checkWords(e,t,s){const o=new Map,r=[];for(const i of e){const n=this.get(i,t,s);n?o.set(i,n):r.push(i)}return{cached:o,uncached:r}}async persist(){try{const e=[];for(const[t,s]of this.cache)e.push({key:t,...s});await f.setLocal({[v.storageKey]:e})}catch(e){console.error("[VocabMeld] Failed to persist cache:",e)}}async clear(){this.cache.clear(),await f.removeLocal(v.storageKey),console.log("[VocabMeld] Cache cleared")}getStats(){return{size:this.cache.size,maxSize:this.maxSize}}getAllWords(){const e=[];for(const[t,s]of this.cache){const[o,r,i]=t.split(":");e.push({original:o,translation:s.translation,phonetic:s.phonetic,difficulty:s.difficulty,sourceLang:r,targetLang:i})}return e}}const z=new J;class q{constructor(){this.config=null}async loadConfig(){return this.config=await f.getConfig(),this.config}async testConnection(e,t,s){try{const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:s,messages:[{role:"user",content:'Say "OK" if you can read this.'}],max_tokens:10})});if(!o.ok){const i=await o.json().catch(()=>({}));throw new Error(i.error?.message||`HTTP ${o.status}`)}const r=await o.json();if(r.choices&&r.choices[0])return{success:!0,message:"连接成功！"};throw new Error("Invalid response format")}catch(o){return{success:!1,message:o.message}}}buildPrompt(e,t,s){const{nativeLanguage:o,targetLanguage:r}=s,i=this.detectLanguage(t)===o;return`你是一个语言学习助手。请分析以下文本，选择适合学习的词汇进行翻译。

## 规则：
1. 选择 15-20 个左右有学习价值的词汇
2. 避免替换：专有名词、人名、地名、品牌名、数字、代码、URL、已经是目标语言的词、小于5个字符的英文单词
3. 优先选择：常用词汇、有学习价值的词汇、不同难度级别的词汇
4. 翻译方向：从 ${i?o:r} 翻译到 ${i?r:o}
5. 翻译倾向：结合上下文，夹杂起来也能容易被理解，尽量只翻译成最合适的词汇，而不是多个含义。

## CEFR等级从简单到复杂依次为：A1-C2

## 输出格式：
返回 JSON 数组，每个元素包含：
- original: 原词（在文本中出现的形式）
- translation: 翻译结果
- phonetic: 学习语言(${r})的音标/发音（如英语用 IPA，中文用拼音，日语用假名）
- difficulty: CEFR 难度等级 (A1/A2/B1/B2/C1/C2)，请谨慎评估
- position: 在文本中的起始位置（字符索引）

## 文本：
${e}

## 输出：
只返回 JSON 数组，不要其他内容。`}reconstructTextWithWords(e,t){const s=new Set(t.map(i=>i.toLowerCase()));e.toLowerCase();const r=e.split(/[.!?]+/).filter(i=>i.trim().length>0).filter(i=>{const n=i.toLowerCase(),l=(i.match(/\b[a-zA-Z]{5,}\b/g)||[]).some(c=>s.has(c.toLowerCase())),d=Array.from(s).some(c=>/[\u4e00-\u9fff]/.test(c)?n.includes(c):!1);return l||d});return r.join(". ").trim()+(r.length>0?".":"")}detectLanguage(e){const t=/[\u4e00-\u9fff]/g,s=/[\u3040-\u309f\u30a0-\u30ff]/g,o=/[\uac00-\ud7af]/g,r=/[a-zA-Z]/g,i=(e.match(t)||[]).length,n=(e.match(s)||[]).length,a=(e.match(o)||[]).length,l=(e.match(r)||[]).length,d=i+n+a+l||1;return n/d>.1?"ja":a/d>.1?"ko":i/d>.3?"zh-CN":(l/d>.3,"en")}async translate(e,t={}){await this.loadConfig();const s={...this.config,...t};if(!s.apiKey||!s.apiEndpoint)throw new Error("API 未配置");await z.init();const o=this.extractWords(e),r=this.detectLanguage(e),i=r===s.nativeLanguage?s.targetLanguage:s.nativeLanguage,{cached:n,uncached:a}=z.checkWords(o,r,i),l=n.size,d=a.length>0?1:0,c=this.filterCachedResults(n,s);if(c.length>=(O[s.intensity]?.maxPerParagraph||8))return await f.updateStats({cacheHits:c.length,cacheMisses:0}),c;if(a.length===0)return await f.updateStats({cacheHits:c.length,cacheMisses:0}),c;const g=this.reconstructTextWithWords(e,a);if(g.trim().length<50)return await f.updateStats({cacheHits:c.length,cacheMisses:0}),c;const y=this.buildPrompt(g,e,s);try{const w=await fetch(s.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`},body:JSON.stringify({model:s.modelName,messages:[{role:"system",content:"你是一个专业的语言学习助手，帮助用户通过沉浸式阅读学习新词汇。始终返回有效的 JSON 格式。"},{role:"user",content:y}],temperature:.3,max_tokens:2e3})});if(!w.ok){const h=await w.json().catch(()=>({}));throw new Error(h.error?.message||`API Error: ${w.status}`)}const A=(await w.json()).choices?.[0]?.message?.content||"[]";let N=this.parseApiResponse(A);const C=N.filter(h=>!(/[\u4e00-\u9fff]/.test(h.original)&&h.original.length<2||/^[a-zA-Z]+$/.test(h.original)&&h.original.length<5)).map(h=>({word:h.original,sourceLang:r,targetLang:i,translation:h.translation,phonetic:h.phonetic,difficulty:h.difficulty||"B1"}));await z.setMany(C);const W=N.filter(h=>!(!P(h.difficulty||"B1",s.difficultyLevel)||/^[a-zA-Z]+$/.test(h.original)&&h.original.length<5)).map(h=>{const L=e.toLowerCase().indexOf(h.original.toLowerCase());return{...h,position:L>=0?L:h.position}});await f.updateStats({newWords:W.length,cacheHits:l,cacheMisses:d});const oe=new Set(W.map(h=>h.original.toLowerCase())),re=n.filter(h=>!oe.has(h.word.toLowerCase())&&P(h.difficulty||"B1",s.difficultyLevel)).map(h=>{const L=e.toLowerCase().indexOf(h.word.toLowerCase());return{original:h.word,translation:h.translation,phonetic:h.phonetic,difficulty:h.difficulty,position:L,fromCache:!0}}),ie=[...W,...re],ne=O[s.intensity]?.maxPerParagraph||8;return ie.slice(0,ne)}catch(w){throw console.error("[VocabMeld] API Error:",w),w}}extractWords(e){const t=e.match(/\b[a-zA-Z]{5,}\b/g)||[],s=[],o=e.match(/[\u4e00-\u9fff]+/g)||[];for(const r of o)if(r.length>=2)for(let i=2;i<=Math.min(4,r.length);i++)for(let n=0;n<=r.length-i;n++){const a=r.substring(n,n+i);s.push(a)}return[...new Set([...t,...s])]}filterCachedResults(e,t){const s=[];for(const[o,r]of e)P(r.difficulty,t.difficultyLevel)&&s.push({original:o,translation:r.translation,phonetic:r.phonetic,difficulty:r.difficulty,fromCache:!0});return s}formatCachedResults(e,t,s){const o=[];for(const[r,i]of t){if(!P(i.difficulty,s.difficultyLevel))continue;const a=new RegExp(`\\b${r}\\b`,"gi").exec(e);a&&o.push({original:a[0],translation:i.translation,phonetic:i.phonetic,difficulty:i.difficulty,position:a.index,fromCache:!0})}return o}parseApiResponse(e){try{let t=JSON.parse(e);return Array.isArray(t)?t:t.results&&Array.isArray(t.results)?t.results:t.words&&Array.isArray(t.words)?t.words:[]}catch{const s=e.match(/\[[\s\S]*\]/);if(s)try{return JSON.parse(s[0])}catch(o){console.error("[VocabMeld] Failed to parse API response:",o)}return[]}}}const I=new q;class X{constructor(){this.isProcessing=!1,this.processingQueue=[],this.observer=null,this.scrollHandler=null,this.debounceTimer=null,this.config=null}async init(){this.config=await f.getConfig(),this.setupScrollListener(),this.setupMutationObserver(),console.log("[VocabMeld] Processing service initialized")}setupScrollListener(){this.scrollHandler&&window.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=this.debounce(()=>{this.config?.autoProcess&&this.config?.enabled&&this.processViewport()},500),window.addEventListener("scroll",this.scrollHandler,{passive:!0})}setupMutationObserver(){this.observer&&this.observer.disconnect(),this.observer=new MutationObserver(this.debounce(e=>{if(!this.config?.autoProcess||!this.config?.enabled)return;e.some(s=>s.addedNodes.length>0&&Array.from(s.addedNodes).some(o=>o.nodeType===Node.ELEMENT_NODE&&o.textContent?.trim().length>50))&&this.processViewport()},1e3)),this.observer.observe(document.body,{childList:!0,subtree:!0})}debounce(e,t){let s;return(...o)=>{clearTimeout(s),s=setTimeout(()=>e.apply(this,o),t)}}async processPage(e={}){if(this.isProcessing)return console.log("[VocabMeld] Already processing, skipping..."),{processed:0,errors:0,skipped:!0};this.isProcessing=!0;let t=0,s=0;try{if(this.config=await f.getConfig(),!this.config.enabled)return{processed:0,errors:0,disabled:!0};const o=window.location.hostname;if(await f.isBlacklisted(o))return console.log("[VocabMeld] Site is blacklisted:",o),{processed:0,errors:0,blacklisted:!0};const r=e.viewportOnly?S.getViewportSegments():S.getPageSegments();console.log(`[VocabMeld] Found ${r.length} segments to process`);const i=await f.getWhitelist(),n=new Set(i.map(a=>a.original.toLowerCase()));for(const a of r)try{let l=a.text;for(const c of n){const g=new RegExp(`\\b${c}\\b`,"gi");l=l.replace(g,"")}if(l.trim().length<30)continue;const d=await I.translate(l);if(d&&d.length>0){const c=d.filter(y=>!n.has(y.original.toLowerCase())),g=T.applyReplacements(a.element,c);t+=g,S.markProcessed(a.fingerprint)}}catch(l){console.error("[VocabMeld] Segment processing error:",l),s++}return console.log(`[VocabMeld] Processed ${t} words with ${s} errors`),{processed:t,errors:s}}catch(o){return console.error("[VocabMeld] Page processing error:",o),{processed:t,errors:s+1,error:o.message}}finally{this.isProcessing=!1}}async processViewport(){return this.processPage({viewportOnly:!0})}restorePage(){this.isProcessing=!1,this.processingQueue=[],T.restoreAll(document.body),S.clearProcessed(),console.log("[VocabMeld] Page restored")}async processSpecificWords(e,t={}){const s=Array.isArray(e)?[...new Set(e.map(i=>(i||"").trim()).filter(Boolean))]:[];if(s.length===0)return{processed:0,errors:0,empty:!0};if(this.isProcessing)return{processed:0,errors:0,skipped:!0};this.isProcessing=!0;let o=0,r=0;try{if(this.config=await f.getConfig(),!this.config.enabled)return{processed:0,errors:0,disabled:!0};const i=new Set(s.map(c=>c.toLowerCase())),n=new Set;document.querySelectorAll(".vocabmeld-translated").forEach(c=>{const g=c.getAttribute("data-original");g&&n.add(g.toLowerCase())});const a=t.viewportOnly?S.getViewportSegments():S.getPageSegments(),l=await f.getWhitelist(),d=new Set((l||[]).map(c=>(c.original||"").toLowerCase()).filter(Boolean));for(const c of a)try{const g=(c.text||"").toLowerCase();if(!g)continue;const y=[];for(const C of i){if(n.has(C)||d.has(C))continue;/^[a-z0-9_-]+$/i.test(C)?new RegExp(`\\b${C.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(c.text)&&y.push(C):g.includes(C)&&y.push(C)}if(y.length===0)continue;const w=await I.translate(c.text);if(!Array.isArray(w)||w.length===0)continue;const R=new Set(y),A=w.filter(C=>C?.original&&R.has(C.original.toLowerCase())).filter(C=>!d.has(C.original.toLowerCase()));if(A.length===0)continue;const N=T.applyReplacements(c.element,A,{translationStyle:this.config.translationStyle,markProcessed:!1});o+=N}catch(g){console.error("[VocabMeld] processSpecificWords segment error:",g),r++}return{processed:o,errors:r}}catch(i){return console.error("[VocabMeld] processSpecificWords error:",i),{processed:o,errors:r+1,error:i.message}}finally{this.isProcessing=!1}}async updateConfig(e){this.config={...this.config,...e}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.scrollHandler&&(window.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.restorePage(),console.log("[VocabMeld] Processing service destroyed")}}const b=new X;class Y{#t=null;#s=null;#e=null;#o=null;constructor(){let e=document.getElementById("vocabmeld-overlay-container");e||(e=this._createElementWithClass("div","vocabmeld-overlay-container"),e.id="vocabmeld-overlay-container",document.body.appendChild(e)),this.overlayContainer=e,this.#t=this.createTooltip(),this.#s=this.createToast(),this.#e=this.createSelectionPopup()}createTooltip(){if(this.#t)return this.#t;const e=this._createElementWithClass("div","vocabmeld-tooltip");e.style.position="fixed",e.style.display="none",e.style.zIndex="2147483647";const t=this._createElementWithClass("div","tooltip-content"),s=this._createElementWithClass("div","translation-line"),o=this._createElementWithClass("span","translation"),r=this._createElementWithClass("span","difficulty-badge");s.appendChild(o),s.appendChild(r);const i=this._createElementWithClass("div","phonetic"),n=this._createElementWithClass("div","hint");return n.textContent="左键点击发音 · 右键标记已学会",t.appendChild(s),t.appendChild(i),t.appendChild(n),e.appendChild(t),this.overlayContainer.appendChild(e),e}showTooltip(e,{translation:t,original:s,phonetic:o,difficulty:r}){this.#t||this.createTooltip();const i=this.#t,n=i.querySelector(".translation"),a=i.querySelector(".difficulty-badge"),l=i.querySelector(".phonetic");n&&(n.textContent=t||""),a&&(a.textContent=r||"B1",a.className=`difficulty-badge cefr-${(r||"B1").toLowerCase()}`),l&&(l.textContent=o?`[${o}]`:"",l.style.display=o?"block":"none");const d=e.getBoundingClientRect(),c=window.pageXOffset||document.documentElement.scrollLeft,g=window.pageYOffset||document.documentElement.scrollTop;i.style.top=`${d.bottom+g+5}px`,i.style.left=`${d.left+c}px`,i.style.display="block",setTimeout(()=>{const y=i.getBoundingClientRect();y.right>window.innerWidth&&(i.style.left=`${window.innerWidth-y.width-10}px`)},0)}hideTooltip(){this.#t&&(this.#t.style.display="none")}createToast(){if(this.#s)return this.#s;const e=this._createElementWithClass("div","vocabmeld-toast");e.style.position="fixed",e.style.right="20px",e.style.bottom="20px",e.style.display="none",e.style.opacity="0",e.style.transition="opacity 0.3s ease-in-out",e.style.zIndex="2147483647";const t=this._createElementWithClass("span","toast-message");return e.appendChild(t),this.overlayContainer.appendChild(e),e}showToast(e,t=2e3){this.#s||this.createToast(),clearTimeout(this.#o);const s=this.#s,o=s.querySelector(".toast-message");o&&(o.textContent=e||""),s.style.display="block",setTimeout(()=>{s.style.opacity="1"},10),this.#o=setTimeout(()=>{s.style.opacity="0",setTimeout(()=>{s.style.display="none"},300)},t)}createSelectionPopup(){if(this.#e)return this.#e;const e=this._createElementWithClass("div","vocabmeld-selection-popup");e.style.position="fixed",e.style.display="none",e.style.zIndex="2147483647";const t=this._createElementWithClass("button","add-to-memorize-btn");return t.type="button",t.textContent="添加到需记忆",e.appendChild(t),this.overlayContainer.appendChild(e),e}showSelectionPopup(e,t,s){this.#e||this.createSelectionPopup();const o=this.#e;o.dataset.word=s||"",o.style.top=`${t}px`,o.style.left=`${e}px`,o.style.display="block"}hideSelectionPopup(){this.#e&&(this.#e.style.display="none",delete this.#e.dataset.word)}getSelectionPopupButton(){return this.#e?this.#e.querySelector(".add-to-memorize-btn"):null}destroy(){this.#t&&this.#t.parentNode&&(this.#t.parentNode.removeChild(this.#t),this.#t=null),this.#s&&this.#s.parentNode&&(this.#s.parentNode.removeChild(this.#s),this.#s=null,clearTimeout(this.#o)),this.#e&&this.#e.parentNode&&(this.#e.parentNode.removeChild(this.#e),this.#e=null),this.overlayContainer&&this.overlayContainer.parentNode&&(this.overlayContainer.parentNode.removeChild(this.overlayContainer),this.overlayContainer=null)}_createElementWithClass(e,t=""){const s=document.createElement(e);return t&&(s.className=t),s}}const m=new Y;class U{async _sendMessage(e,t={}){return new Promise((s,o)=>{const r={action:e,...t};chrome.runtime.sendMessage(r,i=>{if(chrome.runtime.lastError){console.error(`[BackgroundBridge] Message error for action "${e}":`,chrome.runtime.lastError),o(new Error(chrome.runtime.lastError.message));return}s(i)})})}async speak(e){try{await this._sendMessage("speak",{text:e})}catch(t){throw console.error("[BackgroundBridge] Speak failed:",t),t}}async getStats(){try{return await this._sendMessage("getStats")||{totalWords:0,todayWords:0,learnedCount:0,memorizeCount:0,cacheHits:0,cacheMisses:0}}catch(e){return console.error("[BackgroundBridge] getStats failed:",e),{totalWords:0,todayWords:0,learnedCount:0,memorizeCount:0,cacheHits:0,cacheMisses:0}}}async getCacheStats(){try{return await this._sendMessage("getCacheStats")||{size:0,maxSize:2e3}}catch(e){return console.error("[BackgroundBridge] getCacheStats failed:",e),{size:0,maxSize:2e3}}}async clearCache(){try{await this._sendMessage("clearCache")}catch(e){throw console.error("[BackgroundBridge] clearCache failed:",e),e}}async clearLearnedWords(){try{await this._sendMessage("clearLearnedWords")}catch(e){throw console.error("[BackgroundBridge] clearLearnedWords failed:",e),e}}async clearMemorizeList(){try{await this._sendMessage("clearMemorizeList")}catch(e){throw console.error("[BackgroundBridge] clearMemorizeList failed:",e),e}}async testApi(e){try{return await this._sendMessage("testApi",{payload:e})||{success:!1,error:"No response"}}catch(t){return console.error("[BackgroundBridge] testApi failed:",t),{success:!1,error:t.message}}}}const Z=new U;let p=null,E=!1,x=null,k=null;function G(){chrome.runtime.onMessage.addListener((u,e,t)=>{if(!E)return t({success:!1,error:"Not initialized"}),!1;const{action:s}=u;switch(s){case"processPage":return(async()=>{try{const o=await b.processPage({viewportOnly:!1});t({success:!0,...o})}catch(o){console.error("[VocabMeld] processPage error:",o),t({success:!1,error:o.message})}})(),!0;case"restorePage":try{b.restorePage(),m.hideTooltip(),m.hideSelectionPopup(),t({success:!0})}catch(o){console.error("[VocabMeld] restorePage error:",o),t({success:!1,error:o.message})}return!1;case"processSpecificWords":return(async()=>{try{const o=u.words||[],r=await b.processSpecificWords(o);t({success:!0,...r})}catch(o){console.error("[VocabMeld] processSpecificWords error:",o),t({success:!1,error:o.message})}})(),!0;case"getStatus":return t({success:!0,initialized:E,enabled:p?.enabled,isProcessing:b.isProcessing||!1}),!1;default:return t({success:!1,error:"Unknown action"}),!1}})}function Q(){x=f.addChangeListener(async(u,e)=>{if(e!=="sync"&&e!=="local")return;const t={...p};if(p=await f.getConfig(),u.enabled)if(p.enabled){if(!t.enabled&&p.enabled){p.autoProcess&&p.apiKey&&$();return}}else{b.restorePage(),m.hideTooltip(),m.hideSelectionPopup();return}if(["difficultyLevel","intensity","translationStyle","nativeLanguage","targetLanguage","modelName","apiEndpoint","apiKey"].some(r=>u[r])&&p.enabled&&(b.restorePage(),$()),u.memorizeList&&p.enabled){const r=t.memorizeList||[],i=p.memorizeList||[],n=ee(r,i);n.length>0&&b.processSpecificWords(n)}})}function ee(u,e){const t=new Set((u||[]).map(o=>(o.word||"").toLowerCase().trim()).filter(Boolean)),s=[];for(const o of e||[]){const r=(o.word||"").toLowerCase().trim();r&&!t.has(r)&&s.push(o.word)}return s}function $(u=300){clearTimeout(k),k=setTimeout(async()=>{p?.enabled&&p?.apiKey&&await b.processPage()},u)}function te(){const u=document.body;u.addEventListener("mouseover",t=>{const s=t.target.closest(".vocabmeld-translated");s&&m.showTooltip(s,{translation:s.getAttribute("data-translation"),original:s.getAttribute("data-original"),phonetic:p.showPhonetic?s.getAttribute("data-phonetic"):"",difficulty:s.getAttribute("data-difficulty")})}),u.addEventListener("mouseout",t=>{t.target.closest(".vocabmeld-translated")&&m.hideTooltip()}),u.addEventListener("click",async t=>{const s=t.target.closest(".vocabmeld-translated");if(!s)return;const o=s.getAttribute("data-translation")||s.getAttribute("data-original");try{await Z.speak(o)}catch(r){console.error("[VocabMeld] Speak error:",r)}}),u.addEventListener("contextmenu",async t=>{const s=t.target.closest(".vocabmeld-translated");if(!s)return;t.preventDefault();const o=s.getAttribute("data-original"),r=s.getAttribute("data-translation"),i=s.getAttribute("data-difficulty");try{await f.addToWhitelist({original:o,word:r,difficulty:i,addedAt:Date.now()}),T.restoreOriginal(s),m.showToast(`"${o}" 已标记为已学会`)}catch(n){console.error("[VocabMeld] Mark as learned error:",n)}}),document.addEventListener("mouseup",t=>{if(t.target.closest(".vocabmeld-overlay-container")||t.target.closest(".vocabmeld-translated"))return;const o=window.getSelection().toString().trim();o&&o.length>0&&o.length<50?m.showSelectionPopup(t.clientX,t.clientY,o):m.hideSelectionPopup()});const e=m.getSelectionPopupButton();e&&e.addEventListener("click",async()=>{const s=document.querySelector(".vocabmeld-selection-popup")?.dataset.word;if(s)try{const o=p.memorizeList||[];o.some(r=>r.word===s)?m.showToast(`"${s}" 已在记忆列表中`):(o.push({word:s,addedAt:Date.now()}),await f.set({memorizeList:o}),p.memorizeList=o,m.hideSelectionPopup(),m.showToast(`"${s}" 已添加到记忆列表`),await b.processSpecificWords([s]))}catch(o){console.error("[VocabMeld] Add to memorize error:",o)}}),document.addEventListener("mousedown",t=>{t.target.closest(".vocabmeld-selection-popup")||m.hideSelectionPopup()}),window.addEventListener("scroll",()=>{m.hideTooltip()},{passive:!0})}async function V(){if(E){console.log("[VocabMeld] Already initialized, skipping");return}try{E=!0,p=await f.getConfig(),console.log("[VocabMeld] Config loaded:",p.enabled?"enabled":"disabled"),await b.init(p),console.log("[VocabMeld] Processing service initialized"),G(),Q(),te(),console.log("[VocabMeld] Event listeners registered"),p.enabled&&p.autoProcess&&p.apiKey?setTimeout(async()=>{try{await b.processPage(),console.log("[VocabMeld] Auto-processing complete")}catch(u){console.error("[VocabMeld] Auto-processing error:",u)}},1e3):console.log("[VocabMeld] Auto-processing skipped:",{enabled:p.enabled,autoProcess:p.autoProcess,hasApiKey:!!p.apiKey}),console.log("[VocabMeld] Content script initialized successfully")}catch(u){console.error("[VocabMeld] Initialization error:",u),E=!1}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",V,{once:!0}):V(),window.__vocabmeld_destroy=()=>{x&&(x(),x=null),clearTimeout(k),m.destroy(),b.destroy?.(),E=!1}})();
